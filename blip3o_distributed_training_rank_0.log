[Rank 0] 2025-08-09 17:03:04,083 - WARNING - ‚ö†Ô∏è Failed to import model: cannot import name 'BLIP3oCLIPDiTModel' from 'src.modules.models.blip3o_dit' (/gpfs/home4/azadaianchuk1/eva-clip-v2_4/src/modules/models/blip3o_dit.py)
[Rank 0] 2025-08-09 17:03:04,089 - WARNING - ‚ö†Ô∏è Failed to import loss: cannot import name 'BLIP3oCLIPFlowMatchingLoss' from 'src.modules.losses.blip3o_fm_loss' (/gpfs/home4/azadaianchuk1/eva-clip-v2_4/src/modules/losses/blip3o_fm_loss.py)
[Rank 0] 2025-08-09 17:03:05,581 - INFO - ‚úÖ CLIP trainer loaded successfully
[Rank 0] 2025-08-09 17:03:05,583 - INFO - ‚úÖ CLIP datasets loaded successfully
[Rank 0] 2025-08-09 17:03:05,587 - INFO - ‚úÖ Configuration loaded successfully
[Rank 0] 2025-08-09 17:03:05,587 - WARNING - ‚ö†Ô∏è Missing components: ['model', 'loss']
[Rank 0] 2025-08-09 17:03:05,587 - WARNING - ‚ö†Ô∏è Partial initialization. Missing: ['model', 'loss']
[Rank 0] 2025-08-09 17:03:05,601 - INFO - ‚úÖ FSDP utilities loaded successfully
[Rank 0] 2025-08-09 17:03:05,616 - INFO - ‚úÖ Distributed trainer loaded successfully
[Rank 0] 2025-08-09 17:03:07,338 - INFO - ‚úÖ Distributed extraction utilities loaded successfully
[Rank 0] 2025-08-09 17:03:07,345 - INFO - ‚úÖ Distributed dataset utilities loaded successfully
[Rank 0] 2025-08-09 17:03:12,050 - INFO - üéâ BLIP3-o distributed training environment fully initialized!
[Rank 0] 2025-08-09 17:03:12,051 - INFO - ‚ö° Ready for FSDP training with 4 GPUs
[Rank 0] 2025-08-09 17:03:12,066 - INFO - ‚úÖ Distributed environment initialized:
[Rank 0] 2025-08-09 17:03:12,066 - INFO -    World size: 4
[Rank 0] 2025-08-09 17:03:12,066 - INFO -    Backend: nccl
[Rank 0] 2025-08-09 17:03:12,066 - INFO -    Master port: 12355
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üöÄ BLIP3-o Distributed CLIP Reproduction Training (FSDP + NO NORMALIZATION)
[Rank 0] 2025-08-09 17:03:12,066 - INFO - ================================================================================
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üìã Task: Reproduce CLIP embeddings from EVA embeddings
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üß† Model: BLIP3-o DiT WITHOUT CLIP normalization
[Rank 0] 2025-08-09 17:03:12,066 - INFO - ‚ö° Training: FSDP (Fully Sharded Data Parallel)
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üåä Method: Rectified Flow Matching with raw embeddings
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üéØ Target: CLIP embeddings [B, N, 1024] (RAW)
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üéÆ Conditioning: EVA embeddings [B, N, 4096]
[Rank 0] 2025-08-09 17:03:12,066 - INFO - üîë Focus: Distributed training without data-dependent normalization
[Rank 0] 2025-08-09 17:03:12,067 - INFO - üì¶ NEW: FSDP + Smart checkpoint management
[Rank 0] 2025-08-09 17:03:12,067 - INFO - ================================================================================
[Rank 0] 2025-08-09 17:03:12,067 - INFO - Found 50 embedding files
[Rank 0] 2025-08-09 17:03:12,067 - INFO - Available GPUs: 4
[Rank 0] 2025-08-09 17:03:12,067 - INFO -   GPU 0: NVIDIA H100 (100.0 GB)
[Rank 0] 2025-08-09 17:03:12,067 - INFO -   GPU 1: NVIDIA H100 (100.0 GB)
[Rank 0] 2025-08-09 17:03:12,067 - INFO -   GPU 2: NVIDIA H100 (100.0 GB)
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   GPU 3: NVIDIA H100 (100.0 GB)
[Rank 0] 2025-08-09 17:03:12,068 - INFO - PyTorch version: 2.7.1+cu126
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ Distributed dataset module loaded
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ Model module loaded
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ Loss module loaded
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ Distributed trainer module loaded
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ FSDP utilities loaded
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ All distributed modules loaded successfully
[Rank 0] 2025-08-09 17:03:12,068 - INFO - ‚úÖ Temp checkpoint directory ready: /scratch-shared/azadaianchuk1/blip3o_workspace/checkpoints
[Rank 0] 2025-08-09 17:03:12,068 - INFO - Configuration (FSDP + NO NORMALIZATION):
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   World size: 4
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Model size: base
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Training mode: patch_only
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Embeddings dir: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Output dir: /scratch-shared/azadaianchuk1/blip3o_workspace/checkpoints/blip3o_fsdp_20250809_170252
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Temp checkpoint dir: /scratch-shared/azadaianchuk1/blip3o_workspace/checkpoints
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Batch size per GPU: 32
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Total batch size: 128
[Rank 0] 2025-08-09 17:03:12,068 - INFO -   Learning rate: 4e-05
[Rank 0] 2025-08-09 17:03:12,069 - INFO -   Epochs: 8
[Rank 0] 2025-08-09 17:03:12,069 - INFO -   FSDP sharding: FULL_SHARD
[Rank 0] 2025-08-09 17:03:12,069 - INFO -   Mixed precision: BF16
[Rank 0] 2025-08-09 17:03:12,069 - INFO -   CPU offload: Disabled
[Rank 0] 2025-08-09 17:03:12,069 - INFO - üèóÔ∏è Creating model...
[Rank 0] 2025-08-09 17:03:12,069 - INFO - ‚úÖ Configuration validation passed
[Rank 0] 2025-08-09 17:03:12,501 - INFO - ‚úÖ EVA-CLIP Adapter initialized: 4096 ‚Üí 768
[Rank 0] 2025-08-09 17:03:12,501 - INFO -    Layers: 6, Dropout: 0.1, Residual: True
[Rank 0] 2025-08-09 17:03:13,955 - INFO - ‚úÖ Stable initialization applied with depth scale: 0.2887
[Rank 0] 2025-08-09 17:03:13,957 - INFO - ‚úÖ IMPROVED BLIP3-o CLIP DiT model initialized: 227,474,014 parameters
[Rank 0] 2025-08-09 17:03:13,957 - INFO -   üî• EVA adapter: ENABLED
[Rank 0] 2025-08-09 17:03:13,957 - INFO -   üöÄ Heun solver: ENABLED
[Rank 0] 2025-08-09 17:03:13,957 - INFO -   ‚ö° Attention caching: Available
[Rank 0] 2025-08-09 17:03:13,957 - INFO - ‚úÖ IMPROVED BLIP3-o model created:
[Rank 0] 2025-08-09 17:03:13,957 - INFO -    Size: base
[Rank 0] 2025-08-09 17:03:13,958 - INFO -    Parameters: 227,474,014
[Rank 0] 2025-08-09 17:03:13,958 - INFO -    EVA adapter: ‚úÖ
[Rank 0] 2025-08-09 17:03:13,958 - INFO -    Heun solver: ‚úÖ
[Rank 0] 2025-08-09 17:03:13,958 - INFO -    3D RoPE: ‚úÖ
[Rank 0] 2025-08-09 17:03:13,958 - INFO -    Sandwich norm: ‚úÖ
[Rank 0] 2025-08-09 17:03:13,959 - INFO - ‚úÖ Model created with 227,474,014 parameters
[Rank 0] 2025-08-09 17:03:13,959 - INFO -   Model size: base
[Rank 0] 2025-08-09 17:03:13,959 - INFO -   Training mode: patch_only
[Rank 0] 2025-08-09 17:03:13,959 - INFO -   EVA Adapter: ‚úÖ ENABLED
[Rank 0] 2025-08-09 17:03:13,960 - INFO -   Will be wrapped with FSDP: ‚úÖ
[Rank 0] 2025-08-09 17:03:13,960 - INFO - üåä Creating loss function...
[Rank 0] 2025-08-09 17:03:13,960 - INFO - ‚úÖ Flow Matching Loss initialized (NO NORMALIZATION):
[Rank 0] 2025-08-09 17:03:13,960 - INFO -   Prediction type: velocity
[Rank 0] 2025-08-09 17:03:13,960 - INFO -   Flow type: rectified
[Rank 0] 2025-08-09 17:03:13,960 - INFO -   Weights - Velocity: 1.0
[Rank 0] 2025-08-09 17:03:13,960 - INFO - üìä Creating distributed dataloaders...
[Rank 0] 2025-08-09 17:03:13,961 - INFO - Loading embeddings from: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
[Rank 0] 2025-08-09 17:03:13,961 - INFO - Found 50 .pkl files in embeddings directory
[Rank 0] 2025-08-09 17:03:13,961 - INFO - Creating distributed CLIP reproduction dataloaders:
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   World size: 4
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   Rank: 0
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   Batch size per GPU: 32
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   Target: CLIP embeddings [B, N, 1024] (RAW)
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   Conditioning: EVA embeddings [B, N, 4096]
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   Simple scale factor: 1.0
[Rank 0] 2025-08-09 17:03:13,961 - INFO -   Distributed seed: 42
[Rank 0] 2025-08-09 17:03:14,002 - INFO - Loaded manifest: 0 shards, 0 samples
[Rank 0] 2025-08-09 17:03:14,003 - INFO - Found 20 files with pattern: embeddings_shard_*_patch_only.pkl
[Rank 0] 2025-08-09 17:03:14,004 - INFO - Prepared 3 shard files for distributed processing
[Rank 0] 2025-08-09 17:03:19,359 - INFO - Estimated length from first shard: 7,803 samples
[Rank 0] 2025-08-09 17:03:19,380 - INFO - BLIP3-o CLIP Reproduction Dataset initialized (NO NORMALIZATION):
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Mode: patch_only (256 tokens)
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   TARGET: CLIP embeddings [B, N, 1024] (RAW - NO NORMALIZATION)
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   CONDITIONING: EVA embeddings [B, N, 4096]
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Shards: 3
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Simple scale factor: 1.0
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   ‚úÖ CLIP normalization: DISABLED
[Rank 0] 2025-08-09 17:03:19,380 - INFO - [Rank 0] Assigned 1/3 shards
[Rank 0] 2025-08-09 17:03:19,380 - INFO - [Rank 0] Estimated length: 2,601 samples
[Rank 0] 2025-08-09 17:03:19,380 - INFO - Distributed BLIP3-o dataset initialized:
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   World size: 4
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Rank: 0
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Shards per rank: 1
[Rank 0] 2025-08-09 17:03:19,380 - INFO -   Is distributed: True
[Rank 0] 2025-08-09 17:03:19,380 - INFO - Loaded manifest: 0 shards, 0 samples
[Rank 0] 2025-08-09 17:03:19,381 - INFO - Found 20 files with pattern: embeddings_shard_*_patch_only.pkl
[Rank 0] 2025-08-09 17:03:19,381 - INFO - Prepared 3 shard files for distributed processing
[Rank 0] 2025-08-09 17:03:24,310 - INFO - Estimated length from first shard: 7,938 samples
[Rank 0] 2025-08-09 17:03:24,331 - INFO - BLIP3-o CLIP Reproduction Dataset initialized (NO NORMALIZATION):
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   Directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   Mode: patch_only (256 tokens)
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   TARGET: CLIP embeddings [B, N, 1024] (RAW - NO NORMALIZATION)
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   CONDITIONING: EVA embeddings [B, N, 4096]
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   Shards: 3
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   Simple scale factor: 1.0
[Rank 0] 2025-08-09 17:03:24,331 - INFO -   ‚úÖ CLIP normalization: DISABLED
[Rank 0] 2025-08-09 17:03:24,331 - INFO - [Rank 0] Assigned 1/3 shards
[Rank 0] 2025-08-09 17:03:24,331 - INFO - [Rank 0] Estimated length: 2,646 samples
[Rank 0] 2025-08-09 17:03:24,332 - INFO - Distributed BLIP3-o dataset initialized:
[Rank 0] 2025-08-09 17:03:24,332 - INFO -   World size: 4
[Rank 0] 2025-08-09 17:03:24,332 - INFO -   Rank: 0
[Rank 0] 2025-08-09 17:03:24,332 - INFO -   Shards per rank: 1
[Rank 0] 2025-08-09 17:03:24,332 - INFO -   Is distributed: True
[Rank 0] 2025-08-09 17:03:24,332 - ERROR - ‚ùå Error creating distributed dataloaders: DataLoader with IterableDataset: expected unspecified sampler option, but got sampler=<src.modules.datasets.blip3o_distributed_dataset.DistributedSamplerWithSeed object at 0x149a4b3163d0>
[Rank 0] 2025-08-09 17:03:24,332 - ERROR - ‚ùå Distributed training failed on rank 0: DataLoader with IterableDataset: expected unspecified sampler option, but got sampler=<src.modules.datasets.blip3o_distributed_dataset.DistributedSamplerWithSeed object at 0x149a4b3163d0>
[Rank 0] 2025-08-09 17:03:24,332 - ERROR - FULL ERROR TRACEBACK:
[Rank 0] 2025-08-09 17:03:24,334 - INFO - üîß Distributed environment cleaned up
